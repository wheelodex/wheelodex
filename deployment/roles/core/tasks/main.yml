---
- name: apt-get update
  apt: update_cache=true

- name: Install core packages
  apt:
    name:
      - build-essential
      - python3-dev
      - unattended-upgrades
    state: present
    update_cache: false

- name: Create swap space
  command: fallocate -l {{ ansible_memtotal_mb * 2 }}M /swapfile
  args:
    creates: /swapfile
  register: created_swap

- block:
    - name: Create swapfile
      file: path=/swapfile mode=0600

    - name: Make swapfile swappy
      command: mkswap /swapfile

    - name: Add swapfile to fstab
      lineinfile: dest=/etc/fstab line="/swapfile none swap sw 0 0"

    - name: Enable swapfile
      command: swapon /swapfile
  when: created_swap is changed

- name: Set timezone to UTC
  timezone: name=Etc/UTC

- name: Enable unattended upgrades
  debconf:
    name: unattended-upgrades
    question: unattended-upgrades/enable_auto_updates
    vtype: boolean
    value: 'true'
  register: unattup

- name: Enable new unattended-upgrades settings
  command: dpkg-reconfigure -f noninteractive unattended-upgrades
  when: unattup is changed

- name: Configure APT and unattended-upgrades
  copy:
    src: apt.conf
    dest: /etc/apt/apt.conf.d/99local

- name: Create journald.conf.d
  file:
    path: /etc/systemd/journald.conf.d
    state: directory
    owner: root
    group: root

- name: Configure journald
  copy:
    src: journald.conf
    dest: /etc/systemd/journald.conf.d/99local.conf
    backup: true
  notify:
    - Restart journald
